.control
save all

* === DIFFERENTIAL GAIN vs VICM SWEEP ===
let vicm_start = -0.2
let vicm_stop = 1.8
let vicm_step = 25m
let num_points = (vicm_stop - vicm_start) / vicm_step
* Pre-allocate vectors
let vicm_vec = vector(num_points) *0
let gbw_vec = vector(num_points) *0
* Define vectors type
settype voltage vicm_vec
setscale vicm_vec
settype frequency gbw_vec
let vicm_val = vicm_start
let i = 0
while vicm_val le vicm_stop
* Set CM voltage and enable differential input
alter VICM dc = vicm_val
* AC to get DC gain and BW
ac DEC 10 1 10G
meas AC gain max vmag(VOUT)
let stop_band=gain*0.707

meas AC bw WHEN vmag(VOUT)=stop_band
* Store results in pre-allocated vectors
let vicm_vec[i] = vicm_val
let gbw_vec[i] = gain * bw
let vicm_val = vicm_val + vicm_step
let i = i + 1
end
* === MEASUREMENTS ===
meas AC max_gbw max f(gbw_vec)
let limit_gbw = 0.9*max_gbw
meas AC min_vincm find v(vicm_vec) when f(gbw_vec)=limit_gbw RISE=1
meas AC max_vincm find v(vicm_vec) when f(gbw_vec)=limit_gbw FALL=1
let CMIR=max_vincm-min_vincm
print min_vincm max_vincm CMIR
write gbw.raw gbw_vec
.endc